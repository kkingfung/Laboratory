using Unity.Entities;
using Unity.Netcode;
using UnityEngine;
using Laboratory.Models.ECS.Components;

namespace Laboratory.Models.ECS.Systems
{
    /// <summary>
    /// Manages respawn invulnerability timers and removes invulnerability when expired.
    /// This system ensures newly respawned players have temporary protection from damage.
    /// </summary>
    [UpdateInGroup(typeof(SimulationSystemGroup))]
    [UpdateAfter(typeof(RespawnTimerSystemSimple))]
    public partial class RespawnInvulnerabilitySystem : SystemBase
    {
        #region Unity Override Methods

        /// <summary>
        /// Initialize the system and set update requirements.
        /// </summary>
        protected override void OnCreate()
        {
            RequireForUpdate<RespawnInvulnerability>();
        }

        /// <summary>
        /// Updates invulnerability timers and removes expired invulnerability.
        /// Only executes on the server to maintain authoritative state.
        /// </summary>
        protected override void OnUpdate()
        {
            // Only process on server
            if (!NetworkManager.Singleton.IsServer)
                return;

            float deltaTime = SystemAPI.Time.DeltaTime;

            // Process all entities with respawn invulnerability
            Entities
                .ForEach((Entity entity, ref RespawnInvulnerability invulnerability) =>
                {
                    ProcessInvulnerabilityTimer(entity, ref invulnerability, deltaTime);
                })
                .WithStructuralChanges() // Required for component removal
                .Run();
        }

        #endregion

        #region Private Methods

        /// <summary>
        /// Processes invulnerability timer for a single entity.
        /// </summary>
        /// <param name="entity">Entity with invulnerability</param>
        /// <param name="invulnerability">Invulnerability component to update</param>
        /// <param name="deltaTime">Time elapsed since last frame</param>
        private void ProcessInvulnerabilityTimer(Entity entity, ref RespawnInvulnerability invulnerability, float deltaTime)
        {
            // Decrease timer
            invulnerability.TimeRemaining -= deltaTime;

            // Check if invulnerability has expired
            if (invulnerability.TimeRemaining <= 0)
            {
                // Remove invulnerability component
                EntityManager.RemoveComponent<RespawnInvulnerability>(entity);
                
                Debug.Log($"RespawnInvulnerabilitySystem: Invulnerability expired for entity {entity}");
                
                // Optionally trigger visual effect to indicate vulnerability
                TriggerVulnerabilityEffect(entity);
            }
        }

        /// <summary>
        /// Triggers a visual effect when invulnerability ends.
        /// </summary>
        /// <param name="entity">Entity that became vulnerable</param>
        private void TriggerVulnerabilityEffect(Entity entity)
        {
            // Add component for visual systems to pick up
            var effectComponent = new VulnerabilityEffectTrigger
            {
                EffectType = VulnerabilityEffectType.InvulnerabilityEnd
            };
            
            EntityManager.AddComponentData(entity, effectComponent);
        }

        #endregion
    }

    #region Additional Components

    /// <summary>
    /// Component to trigger vulnerability visual effects.
    /// </summary>
    public struct VulnerabilityEffectTrigger : IComponentData
    {
        /// <summary>Type of vulnerability effect to display.</summary>
        public VulnerabilityEffectType EffectType;
    }

    /// <summary>
    /// Types of vulnerability effects available.
    /// </summary>
    public enum VulnerabilityEffectType : byte
    {
        InvulnerabilityEnd,
        ShieldDown,
        ProtectionExpired
    }

    #endregion
}

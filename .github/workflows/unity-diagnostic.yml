name: Unity CI Diagnostic

on:
  workflow_dispatch:  # Allow manual trigger
  push:
    branches: [ main ]
    paths:
      - '.github/workflows/**'

env:
  UNITY_VERSION: 6000.2.0f1

jobs:
  diagnostic:
    name: Unity CI Diagnostic
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Check Secrets Configuration
        run: |
          echo "üîç Checking Unity secrets configuration..."
          echo "=================================================="

          # Check licensing method
          license_method=""
          if [ -n "${{ secrets.UNITY_LICENSE }}" ]; then
            echo "‚úÖ UNITY_LICENSE secret is configured (Personal License method)"
            license_method="personal"
          fi

          if [ -n "${{ secrets.UNITY_SERIAL }}" ]; then
            echo "‚úÖ UNITY_SERIAL secret is configured (Professional License method)"
            if [ -n "$license_method" ]; then
              echo "‚ö†Ô∏è  WARNING: Both UNITY_LICENSE and UNITY_SERIAL are set - use only one method"
            fi
            license_method="professional"
          fi

          if [ -z "$license_method" ]; then
            echo "‚ùå CRITICAL: No Unity license configured"
            echo "   You must set either UNITY_LICENSE or UNITY_SERIAL"
            echo "   See .github/SETUP-UNITY-SECRETS.md for instructions"
          fi

          # Check credentials
          if [ -n "${{ secrets.UNITY_EMAIL }}" ]; then
            echo "‚úÖ UNITY_EMAIL secret is configured"
          else
            echo "‚ùå UNITY_EMAIL secret is missing"
          fi

          if [ -n "${{ secrets.UNITY_PASSWORD }}" ]; then
            echo "‚úÖ UNITY_PASSWORD secret is configured"
          else
            echo "‚ùå UNITY_PASSWORD secret is missing"
          fi

          echo "=================================================="

          # Setup instructions based on what's missing
          if [ -z "$license_method" ]; then
            echo ""
            echo "üö® SETUP REQUIRED:"
            echo "1. Choose your license type (Personal or Professional)"
            echo "2. Follow instructions in .github/SETUP-UNITY-SECRETS.md"
            echo "3. Add the required secrets to GitHub repository settings"
            echo "4. Re-run this diagnostic to verify setup"
          elif [ -z "${{ secrets.UNITY_EMAIL }}" ] || [ -z "${{ secrets.UNITY_PASSWORD }}" ]; then
            echo ""
            echo "üö® CREDENTIALS MISSING:"
            echo "Add UNITY_EMAIL and UNITY_PASSWORD secrets to complete setup"
          else
            echo ""
            echo "‚úÖ All Unity secrets appear to be configured!"
            echo "If you still get licensing errors, verify:"
            echo "- Your Unity account credentials are correct"
            echo "- Your license is active and properly formatted"
          fi

      - name: Enhanced Unity Library Cache
        uses: actions/cache@v4
        with:
          path: |
            Library
            obj
            Temp
            UserSettings
            Logs
          key: Library-diagnostic-${{ runner.os }}-${{ env.UNITY_VERSION }}-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-diagnostic-${{ runner.os }}-${{ env.UNITY_VERSION }}-
            Library-diagnostic-${{ runner.os }}-

      - name: Test Unity Build with Proper Configuration
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_SERIAL: ${{ secrets.UNITY_SERIAL }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          unityVersion: ${{ env.UNITY_VERSION }}
          targetPlatform: StandaloneWindows64
          buildName: DiagnosticBuild
          buildsPath: Builds/Diagnostic
          buildMethod: BuildScript.BuildProject
          versioning: Semantic
          version: 1.0.${{ github.run_number }}
        continue-on-error: true

      - name: Diagnostic Results
        run: |
          echo "üöÄ Unity CI Diagnostic Complete"
          echo "Check the logs above for:"
          echo "1. ‚úÖ/‚ùå Unity secrets configuration status"
          echo "2. üì¶ Library caching effectiveness"
          echo "3. üîß Build process success/failure details"
          echo ""
          echo "If build failed, common issues:"
          echo "- Missing Unity license secrets (see README.md for setup)"
          echo "- Incorrect Unity version specification"
          echo "- Missing BuildScript.BuildProject method"

      - name: Upload Diagnostic Build (if successful)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: diagnostic-build-${{ github.run_number }}
          path: |
            Builds/Diagnostic
            Logs
          retention-days: 7
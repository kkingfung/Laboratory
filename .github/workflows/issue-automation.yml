name: Issue & PR Automation

on:
  issues:
    types: [opened, labeled, assigned]
  pull_request:
    types: [opened, labeled, assigned, ready_for_review]
  issue_comment:
    types: [created]

jobs:
  issue-triage:
    name: Automatic Issue Triage
    runs-on: ubuntu-latest
    if: github.event_name == 'issues' && github.event.action == 'opened'

    steps:
      - name: Auto-label Performance Issues
        if: contains(github.event.issue.title, '[PERFORMANCE]') || contains(github.event.issue.body, 'Performance Auditor Tool')
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['performance', 'needs-investigation', 'high-priority']
            });

            // Add automated comment with tool guidance
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ğŸš€ **Performance Issue Detected**

              Thank you for reporting a performance issue! To help us investigate:

              ## ğŸ“Š Required Information
              Please ensure you've included:
              - Performance Auditor Tool output from Unity Editor
              - Unity Profiler screenshots or data
              - Specific performance metrics (FPS, memory usage)
              - Reproduction steps

              ## ğŸ› ï¸ Next Steps
              1. **Performance Auditor Tool**: Unity Editor â†’ Menu â†’ \`ğŸš€ Laboratory/Performance Auditor\`
              2. **QA Automation Tool**: Run performance checks â†’ \`ğŸ› ï¸ Laboratory/QA Automation\`
              3. **Unity Profiler**: Capture performance data for analysis

              ## âš¡ Priority
              This issue has been automatically labeled as high-priority due to performance impact.

              *This is an automated response to help streamline performance issue resolution.*`
            });

      - name: Auto-label Developer Experience Issues
        if: contains(github.event.issue.title, '[DEV-EX]') || contains(github.event.issue.labels.*.name, 'developer-experience')
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['developer-experience', 'workflow', 'tooling']
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ğŸ› ï¸ **Developer Experience Issue**

              Thank you for helping improve our development workflow!

              ## ğŸ” Investigation Tools
              - **GameDev Workflow Tool**: \`âš¡ Laboratory/GameDev Workflow\`
              - **QA Automation Tool**: \`ğŸ› ï¸ Laboratory/QA Automation\`
              - **Performance Auditor Tool**: \`ğŸš€ Laboratory/Performance Auditor\`

              ## ğŸ“‹ Assessment
              This issue will be evaluated for:
              - Impact on developer productivity
              - Tool enhancement opportunities
              - Workflow optimization potential
              - Documentation improvements

              A team member will review and prioritize this issue based on developer impact.`
            });

      - name: Auto-label Bug Reports
        if: contains(github.event.issue.title, '[BUG]') || contains(github.event.issue.labels.*.name, 'bug')
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['bug', 'needs-triage']
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ğŸ› **Bug Report Received**

              Thank you for the bug report! To help us resolve this quickly:

              ## ğŸ” Quality Assurance
              Please run our QA tools to gather additional information:
              - **QA Automation Tool**: \`ğŸ› ï¸ Laboratory/QA Automation\` â†’ Run relevant validation checks
              - **GameDev Workflow Tool**: \`âš¡ Laboratory/GameDev Workflow\` â†’ Perform health check

              ## ğŸ“Š Additional Data
              If performance-related, also run:
              - **Performance Auditor Tool**: \`ğŸš€ Laboratory/Performance Auditor\`

              ## ğŸ¯ Next Steps
              1. Issue will be triaged by the team
              2. Priority assigned based on severity and impact
              3. Developer assigned for investigation and resolution

              *Tools are available in Unity Editor â†’ Menu â†’ Laboratory â†’ [Tool Name]*`
            });

  stale-issue-management:
    name: Stale Issue Management
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' # This would need to be triggered by a schedule

    steps:
      - name: Mark Stale Issues
        uses: actions/stale@v9
        with:
          stale-issue-message: |
            ğŸ•’ **Stale Issue Notice**

            This issue has been automatically marked as stale because it has not had recent activity.

            ## ğŸ”„ To Keep This Issue Active:
            - Add a comment with updates or additional information
            - Run our Unity Editor tools for updated analysis:
              - ğŸš€ Performance Auditor Tool
              - ğŸ› ï¸ QA Automation Tool
              - âš¡ GameDev Workflow Tool
            - Provide additional reproduction steps or context

            ## â° Timeline:
            - **7 days**: This issue will be automatically closed if no activity
            - **Activity**: Any comment or update will remove the stale label

            Thank you for helping maintain Project Chimera! ğŸ§¬
          stale-issue-label: 'stale'
          exempt-issue-labels: 'pinned,security,critical,high-priority'
          days-before-stale: 30
          days-before-close: 7

  pr-automation:
    name: PR Workflow Automation
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Welcome First-Time Contributors
        if: github.event.action == 'opened'
        uses: actions/github-script@v7
        with:
          script: |
            // Check if this is a first-time contributor
            const { data: pullRequests } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'all',
              creator: context.payload.pull_request.user.login
            });

            if (pullRequests.length === 1) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `ğŸ‰ **Welcome to Project Chimera!**

                Thank you for your first contribution to our Unity 6 monster breeding game!

                ## ğŸ› ï¸ Development Tools Available
                Before your PR is reviewed, please ensure you've used our development tools:

                ### ğŸš€ Performance Auditor Tool
                - **Purpose**: Automated performance pattern detection
                - **Access**: Unity Editor â†’ Menu â†’ \`ğŸš€ Laboratory/Performance Auditor\`
                - **When**: Run before committing code changes

                ### ğŸ› ï¸ QA Automation Tool
                - **Purpose**: Comprehensive project validation
                - **Access**: Unity Editor â†’ Menu â†’ \`ğŸ› ï¸ Laboratory/QA Automation\`
                - **When**: Run before submitting PR

                ### âš¡ GameDev Workflow Tool
                - **Purpose**: Development workflow utilities
                - **Access**: Unity Editor â†’ Menu â†’ \`âš¡ Laboratory/GameDev Workflow\`
                - **When**: Use for daily development tasks

                ## ğŸ“‹ Pre-Review Checklist
                - [ ] Code compiles without warnings
                - [ ] Performance Auditor Tool run (if code changes)
                - [ ] QA Automation Tool validation passed
                - [ ] Tests added for new functionality
                - [ ] Documentation updated as needed

                ## ğŸ¤ Review Process
                1. Automated CI/CD checks will run
                2. Team member will review your code
                3. Address any feedback or requested changes
                4. Once approved, your PR will be merged!

                Welcome to the team! ğŸ§¬âœ¨`
              });

              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['first-time-contributor']
              });
            }

      - name: Tool Usage Reminder
        if: github.event.action == 'ready_for_review'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ğŸ” **PR Ready for Review - Tool Usage Reminder**

              Your PR has been marked as ready for review. Before the review begins:

              ## âœ… Required Tool Checks
              Please confirm you've run the following Unity Editor tools:

              ### ğŸš€ Performance Auditor Tool
              - [ ] Run automated performance analysis
              - [ ] Address any critical performance issues found
              - [ ] Include results in PR description if performance-critical changes

              ### ğŸ› ï¸ QA Automation Tool
              - [ ] Run comprehensive validation checks
              - [ ] Ensure all quality gates pass
              - [ ] Fix any issues identified

              ### âš¡ GameDev Workflow Tool
              - [ ] Use health check functionality
              - [ ] Verify project structure and organization

              ## ğŸ“Š CI/CD Pipeline
              The automated pipeline will also run:
              - Performance risk assessment
              - Code quality analysis
              - Build verification
              - Test execution

              ## ğŸ¯ Review Priority
              PRs with proper tool usage and passing CI checks will be prioritized for review.

              *Access tools: Unity Editor â†’ Menu â†’ Laboratory â†’ [Tool Name]*`
            });

  comment-automation:
    name: Comment-based Automation
    runs-on: ubuntu-latest
    if: github.event_name == 'issue_comment' && github.event.action == 'created'

    steps:
      - name: Tool Usage Commands
        if: contains(github.event.comment.body, '/run-tools')
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `ğŸ› ï¸ **Unity Editor Tools - Usage Instructions**

              Here's how to run our development tools:

              ## ğŸš€ Performance Auditor Tool
              \`\`\`
              1. Unity Editor â†’ Menu â†’ ğŸš€ Laboratory/Performance Auditor
              2. Click "Scan All Scripts" for comprehensive analysis
              3. Review issues by severity (Critical â†’ High â†’ Medium â†’ Low)
              4. Click "Open File" to navigate to problematic code
              5. Apply suggested optimizations
              \`\`\`

              ## ğŸ› ï¸ QA Automation Tool
              \`\`\`
              1. Unity Editor â†’ Menu â†’ ğŸ› ï¸ Laboratory/QA Automation
              2. Click "Run All QA Checks" for full validation
              3. Review results by category (Scene, Asset, Performance, Build)
              4. Address any failed checks before submitting PR
              5. Use "Quick Validation" for rapid checks
              \`\`\`

              ## âš¡ GameDev Workflow Tool
              \`\`\`
              1. Unity Editor â†’ Menu â†’ âš¡ Laboratory/GameDev Workflow
              2. Use Quick Actions for common tasks
              3. Scene Management for scene operations
              4. Asset Tools for project organization
              5. Debug Tools for project health checks
              \`\`\`

              ## ğŸ“Š Reporting Results
              When reporting issues, include:
              - Tool output screenshots or text
              - Performance metrics from Unity Profiler
              - Specific error messages or warnings
              - System specifications if performance-related

              These tools are designed to catch issues early and improve code quality!`
            });

      - name: Performance Analysis Command
        if: contains(github.event.comment.body, '/analyze-performance')
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `âš¡ **Performance Analysis Guide**

              For comprehensive performance analysis:

              ## ğŸ” Step-by-Step Analysis
              1. **Performance Auditor Tool**
                 - Unity Editor â†’ Menu â†’ ğŸš€ Laboratory/Performance Auditor
                 - Run "Scan All Scripts" or "Quick Scan (Update methods only)"
                 - Focus on Critical and High severity issues first

              2. **Unity Profiler**
                 - Window â†’ Analysis â†’ Profiler
                 - Capture performance data during problematic scenarios
                 - Focus on CPU, Memory, and Rendering modules

              3. **QA Automation Performance Checks**
                 - Unity Editor â†’ Menu â†’ ğŸ› ï¸ Laboratory/QA Automation
                 - Expand "Performance Checks" section
                 - Run individual performance validation tests

              ## ğŸ“Š Key Metrics to Monitor
              - **FPS**: Target 60+ FPS for smooth gameplay
              - **Memory**: Monitor GC allocations and leaks
              - **Draw Calls**: Keep reasonable for target platform
              - **Physics**: Check collision detection costs
              - **AI/Pathfinding**: Monitor monster behavior performance

              ## ğŸ¯ Common Performance Issues
              - FindObjectOfType/GameObject.Find in Update methods
              - Repeated GetComponent calls without caching
              - LINQ operations in hot paths
              - String concatenation causing GC pressure
              - Missing object pooling for frequent instantiation

              Include tool outputs and profiler data in your issue for best support!`
            });`
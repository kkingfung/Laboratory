name: Performance Monitoring & Optimization

on:
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'Assets/**/*.cs'
  push:
    branches: [ main ]
    paths:
      - 'Assets/**/*.cs'
  schedule:
    - cron: '0 6 * * *' # Daily at 6 AM

jobs:
  performance-audit:
    name: Automated Performance Audit
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Performance Anti-Pattern Detection
        run: |
          echo "üîç Scanning for performance anti-patterns..."

          # Track performance issues
          performance_issues=0

          # Check for expensive operations in MonoBehaviour.Update methods (ECS-aware)
          echo "Checking for expensive MonoBehaviour.Update operations..."
          expensive_updates=$(grep -rn "void Update().*{" Assets/_Project/Scripts --include="*.cs" -A 10 | grep -E "GameObject\.Find|FindObjectOfType|GetComponent" | wc -l)
          if [ $expensive_updates -gt 5 ]; then
            echo "‚ö†Ô∏è Found $expensive_updates expensive operations in MonoBehaviour.Update methods"
            performance_issues=$((performance_issues + 3))
          else
            echo "‚úÖ No significant expensive Update operations found"
          fi

          # Check for LINQ in ECS systems (more lenient for non-ECS code)
          echo "Checking for LINQ in ECS hot paths..."
          linq_in_ecs=$(grep -rn "IJobEntity\|ISystem\|SystemBase" Assets/ --include="*.cs" -A 20 | grep -E "\.Where\(|\.Select\(|\.OrderBy\(" | wc -l)
          if [ $linq_in_ecs -gt 10 ]; then
            echo "‚ö†Ô∏è Found $linq_in_ecs LINQ operations in ECS systems - verify performance"
            performance_issues=$((performance_issues + 2))
          else
            echo "‚úÖ LINQ usage in ECS systems appears reasonable"
          fi

          # Check for string concatenation in hot paths
          echo "Checking for string concatenation in hot paths..."
          string_concat_hot=$(grep -rn "void Update()\|void OnUpdate()\|Execute(" Assets/ --include="*.cs" -A 5 | grep '"\s*+\s*"' | wc -l)
          if [ $string_concat_hot -gt 10 ]; then
            echo "‚ö†Ô∏è Found $string_concat_hot string concatenations in hot paths"
            performance_issues=$((performance_issues + 2))
          else
            echo "‚úÖ String concatenation in hot paths appears minimal"
          fi

          # Check for GameObject.Instantiate without pooling (ECS should use EntityManager)
          echo "Checking for GameObject instantiation (prefer ECS entity spawning)..."
          instantiate_count=$(grep -rn "GameObject\.Instantiate\|Instantiate<" Assets/ --include="*.cs" | wc -l)
          if [ $instantiate_count -gt 30 ]; then
            echo "‚ö†Ô∏è Found $instantiate_count GameObject.Instantiate calls - prefer ECS entity spawning"
            performance_issues=$((performance_issues + 2))
          else
            echo "‚úÖ GameObject.Instantiate usage appears reasonable"
          fi

          # Check for allocations in MonoBehaviour.Update (ignore ECS OnUpdate)
          echo "Checking for allocations in MonoBehaviour.Update methods..."
          update_allocs=$(grep -rn "void Update()" Assets/ --include="*.cs" -A 15 | grep -E "new List|new Dictionary|new Array|new GameObject" | wc -l)
          if [ $update_allocs -gt 10 ]; then
            echo "‚ö†Ô∏è Found $update_allocs allocations in MonoBehaviour.Update methods"
            performance_issues=$((performance_issues + 3))
          else
            echo "‚úÖ No significant allocations in Update methods found"
          fi

          # Check for missing [BurstCompile] on IJobEntity
          echo "Checking for missing [BurstCompile] attributes..."
          jobs_without_burst=$(grep -rn "IJobEntity\|IJobChunk" Assets/ --include="*.cs" -B 2 | grep -v "BurstCompile" | grep "struct.*IJob" | wc -l)
          if [ $jobs_without_burst -gt 5 ]; then
            echo "‚ö†Ô∏è Found $jobs_without_burst jobs without [BurstCompile] - performance opportunity"
            performance_issues=$((performance_issues + 2))
          else
            echo "‚úÖ Most jobs are Burst-compiled"
          fi

          # Summary
          echo "üìä Performance Audit Summary (ECS-Optimized):"
          echo "- Total performance issue severity: $performance_issues"

          if [ $performance_issues -gt 15 ]; then
            echo "üî¥ CRITICAL: High number of performance issues detected"
            echo "performance_status=critical" >> $GITHUB_ENV
          elif [ $performance_issues -gt 8 ]; then
            echo "üü† WARNING: Moderate performance issues detected"
            echo "performance_status=warning" >> $GITHUB_ENV
          else
            echo "‚úÖ GOOD: Performance looks healthy for ECS project"
            echo "performance_status=good" >> $GITHUB_ENV
          fi

      - name: Generate Performance Report
        run: |
          cat > performance-report.md << EOF
          # üöÄ Performance Monitoring Report

          **Repository**: ${{ github.repository }}
          **Branch**: ${{ github.ref_name }}
          **Commit**: ${{ github.sha }}
          **Date**: $(date)
          **Status**: ${{ env.performance_status }}

          ## üìä Performance Metrics (ECS-Optimized)

          ### Anti-Pattern Detection Results
          - **MonoBehaviour.Update Anti-Patterns**: Checked for expensive operations
          - **LINQ in ECS Systems**: Analyzed hot path usage in jobs/systems
          - **String Concatenation**: Checked hot paths for GC pressure
          - **GameObject Instantiation**: Verified ECS entity spawning vs GameObject
          - **Memory Allocations**: Scanned MonoBehaviour.Update methods
          - **Burst Compilation**: Verified [BurstCompile] usage on jobs

          ### ECS Performance Best Practices
          - Use [BurstCompile] on all IJobEntity and IJobChunk jobs
          - Prefer EntityManager.Instantiate over GameObject.Instantiate
          - Avoid LINQ in IJobEntity Execute() methods
          - Cache ComponentLookup references in OnCreate()
          - Use NativeContainers instead of managed collections in jobs
          - Profile using Unity Profiler + ECS Profiler for detailed analysis

          ### Performance Tools Available
          - üöÄ Performance Auditor Tool (Unity Editor)
          - üõ†Ô∏è QA Automation Tool (Unity Editor)
          - ‚ö° GameDev Workflow Tool (Unity Editor)

          EOF

      - name: Upload Performance Report
        uses: actions/upload-artifact@v4
        with:
          name: performance-report-${{ github.sha }}
          path: performance-report.md
          retention-days: 30

      - name: Comment PR with Performance Status
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const status = process.env.performance_status;
            let emoji = '‚úÖ';
            let message = 'Performance audit passed!';

            if (status === 'critical') {
              emoji = 'üî¥';
              message = 'Critical performance issues detected! Please review and optimize.';
            } else if (status === 'warning') {
              emoji = 'üü†';
              message = 'Performance issues detected. Consider optimizing before merge.';
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${emoji} **Performance Audit Results**

              ${message}

              üìä View detailed performance report in the workflow artifacts.
              üõ†Ô∏è Use the Performance Auditor Tool in Unity Editor for detailed analysis.`
            });

      - name: Performance Gate Check
        run: |
          if [ "${{ env.performance_status }}" = "critical" ]; then
            echo "üö® Performance gate failed - critical issues must be addressed"
            exit 1
          else
            echo "‚úÖ Performance gate passed"
          fi
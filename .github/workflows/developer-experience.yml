name: Developer Experience & Automation

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  developer-tools-validation:
    name: Validate Developer Tools
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate Unity Editor Tools
        run: |
          echo "üõ†Ô∏è Validating Unity Editor Tools..."

          # Check if our custom editor tools exist
          tools=(
            "Assets/Editor/PerformanceAuditorTool.cs"
            "Assets/Editor/QAAutomationTool.cs"
            "Assets/Editor/GameDevWorkflowTool.cs"
          )

          missing_tools=0
          for tool in "${tools[@]}"; do
            if [ -f "$tool" ]; then
              echo "‚úÖ Found: $tool"
            else
              echo "‚ùå Missing: $tool"
              missing_tools=$((missing_tools + 1))
            fi
          done

          if [ $missing_tools -gt 0 ]; then
            echo "‚ö†Ô∏è $missing_tools developer tools are missing"
          else
            echo "‚úÖ All developer tools are present"
          fi

      - name: Check Code Standards Compliance
        run: |
          echo "üìã Checking code standards compliance..."

          # Check for proper namespace usage
          echo "Checking namespace compliance..."
          namespace_issues=$(grep -r "namespace.*{" Assets/ --include="*.cs" | grep -v "Laboratory\." | wc -l)
          if [ $namespace_issues -gt 0 ]; then
            echo "‚ö†Ô∏è Found $namespace_issues files not using Laboratory namespace"
          else
            echo "‚úÖ Namespace compliance looks good"
          fi

          # Check for proper header comments
          echo "Checking for XML documentation..."
          total_classes=$(grep -r "public class\|public interface" Assets/_Project --include="*.cs" | wc -l)
          documented_classes=$(grep -r "/// <summary>" Assets/_Project --include="*.cs" -A1 | grep "public class\|public interface" | wc -l)

          if [ $total_classes -gt 0 ]; then
            doc_percentage=$((documented_classes * 100 / total_classes))
            echo "üìñ Documentation coverage: $doc_percentage% ($documented_classes/$total_classes)"

            if [ $doc_percentage -lt 70 ]; then
              echo "‚ö†Ô∏è Low documentation coverage - aim for 80%+"
            else
              echo "‚úÖ Good documentation coverage"
            fi
          fi

          # Check for proper error handling
          echo "Checking error handling patterns..."
          try_blocks=$(grep -r "try\s*{" Assets/ --include="*.cs" | wc -l)
          catch_blocks=$(grep -r "catch\s*(" Assets/ --include="*.cs" | wc -l)

          if [ $try_blocks -ne $catch_blocks ]; then
            echo "‚ö†Ô∏è Mismatched try/catch blocks detected"
          else
            echo "‚úÖ Try/catch blocks are balanced"
          fi

      - name: Generate Developer Guidelines
        run: |
          cat > developer-guidelines.md << 'EOF'
          # üöÄ Developer Guidelines - Project Chimera

          ## üõ†Ô∏è Available Tools

          ### Unity Editor Tools
          - **üöÄ Performance Auditor Tool** - Menu: `üöÄ Laboratory/Performance Auditor`
            - Automated performance pattern detection
            - Real-time code scanning for bottlenecks
            - One-click navigation to issues

          - **üõ†Ô∏è QA Automation Tool** - Menu: `üõ†Ô∏è Laboratory/QA Automation`
            - Comprehensive automated testing
            - Scene, Asset, Performance, and Build validation
            - Pre-build quality gates

          - **‚ö° GameDev Workflow Tool** - Menu: `‚ö° Laboratory/GameDev Workflow`
            - Quick development actions
            - Scene management utilities
            - Asset organization tools

          ## üìã Coding Standards

          ### Namespace Convention
          ```csharp
          namespace Laboratory.Subsystems.AI
          {
              // Your code here
          }
          ```

          ### Documentation Requirements
          ```csharp
          /// <summary>
          /// Description of what this class does
          /// </summary>
          public class MyClass : MonoBehaviour
          {
              /// <summary>
              /// Description of what this method does
              /// </summary>
              /// <param name="parameter">What this parameter is for</param>
              /// <returns>What this method returns</returns>
              public bool MyMethod(string parameter)
              {
                  // Implementation
              }
          }
          ```

          ### Performance Best Practices
          - ‚úÖ Cache component references in Awake/Start
          - ‚úÖ Use object pooling for frequently spawned objects
          - ‚úÖ Avoid expensive operations in Update loops
          - ‚úÖ Use StringBuilder for string concatenation
          - ‚ùå Don't use FindObjectOfType in Update
          - ‚ùå Don't use GetComponent repeatedly
          - ‚ùå Don't allocate memory in Update loops

          ### Error Handling
          ```csharp
          try
          {
              // Risky operation
          }
          catch (SpecificException e)
          {
              Debug.LogError($"Specific error: {e.Message}");
              // Handle specific case
          }
          catch (System.Exception e)
          {
              Debug.LogError($"Unexpected error: {e.Message}");
              // Handle general case
          }
          ```

          ## üöÄ Workflow

          ### Before Coding
          1. Run **QA Automation Tool** to check project health
          2. Use **Performance Auditor Tool** to check current state
          3. Create feature branch from develop

          ### During Development
          1. Use **GameDev Workflow Tool** for common tasks
          2. Run tests frequently with QA tool
          3. Monitor performance with auditor tool

          ### Before PR
          1. Run full QA automation suite
          2. Check performance audit results
          3. Ensure all tools validate successfully
          4. Update documentation as needed

          ## üîß Troubleshooting

          ### Common Issues
          - **Performance Issues**: Use Performance Auditor Tool
          - **Build Failures**: Use QA Automation Tool
          - **Missing Components**: Use GameDev Workflow health check
          - **Test Failures**: Check QA tool for detailed reports

          ### Getting Help
          - Check tool outputs and recommendations
          - Review CI/CD pipeline results
          - Consult team in PR reviews

          EOF

      - name: Upload Developer Guidelines
        uses: actions/upload-artifact@v4
        with:
          name: developer-guidelines
          path: developer-guidelines.md
          retention-days: 90

  automated-onboarding:
    name: Automated Developer Onboarding
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate Project Overview
        run: |
          cat > project-overview.md << 'EOF'
          # üß¨ Project Chimera - Developer Onboarding

          ## üéÆ Project Overview
          Project Chimera is a Unity 6 3D action game featuring:
          - **Monster Breeding System** - Create unique creatures through genetics
          - **Advanced AI Behavior** - Monsters with evolving personalities
          - **Multiplayer Support** - Breed and battle with friends
          - **Performance-Optimized** - Built for scalability and smooth gameplay

          ## üèóÔ∏è Architecture
          - **Unity 6** - Latest Unity LTS for cutting-edge features
          - **ECS (Entities)** - High-performance systems for monsters and AI
          - **Netcode for Entities** - Robust multiplayer networking
          - **Custom Tools** - Built-in developer productivity tools

          ## üìÅ Project Structure
          ```
          Assets/
          ‚îú‚îÄ‚îÄ _Project/           # Main project code
          ‚îÇ   ‚îú‚îÄ‚îÄ Scripts/        # C# scripts organized by subsystem
          ‚îÇ   ‚îú‚îÄ‚îÄ Art/           # 3D models, textures, materials
          ‚îÇ   ‚îú‚îÄ‚îÄ Audio/         # Sound effects and music
          ‚îÇ   ‚îî‚îÄ‚îÄ Scenes/        # Game scenes
          ‚îú‚îÄ‚îÄ Editor/            # Custom Unity editor tools
          ‚îú‚îÄ‚îÄ Tests/             # Automated tests
          ‚îî‚îÄ‚îÄ StreamingAssets/   # Runtime-loaded assets
          ```

          ## üöÄ Quick Start
          1. **Clone Repository**: `git clone [repo-url]`
          2. **Open in Unity 6**: Version 6000.2.0b7 or later
          3. **Install Tools**: Editor tools auto-install on first load
          4. **Run Tests**: Use QA Automation Tool
          5. **Start Coding**: Follow developer guidelines

          ## üõ†Ô∏è Development Workflow
          1. **Feature Branch**: Create from `develop`
          2. **Code & Test**: Use built-in tools for quality assurance
          3. **Performance Check**: Run Performance Auditor Tool
          4. **Pull Request**: Detailed template guides review
          5. **CI/CD**: Automated testing and deployment

          ## üîß Essential Tools Usage

          ### Performance Auditor Tool
          - **When to use**: Before committing performance-critical code
          - **How to use**: Menu ‚Üí `üöÄ Laboratory/Performance Auditor`
          - **What it does**: Scans code for performance anti-patterns

          ### QA Automation Tool
          - **When to use**: Before submitting PR, daily development
          - **How to use**: Menu ‚Üí `üõ†Ô∏è Laboratory/QA Automation`
          - **What it does**: Comprehensive project health checks

          ### GameDev Workflow Tool
          - **When to use**: Daily development tasks
          - **How to use**: Menu ‚Üí `‚ö° Laboratory/GameDev Workflow`
          - **What it does**: Streamlines common development actions

          ## üìû Support
          - **Issues**: Use GitHub issue templates
          - **Questions**: Check existing documentation
          - **Bugs**: Detailed bug report template available
          - **Features**: Feature request template guides requirements

          ## üéØ Success Metrics
          - **Code Quality**: Automated analysis in CI/CD
          - **Performance**: Built-in monitoring and alerting
          - **Test Coverage**: Tracked in quality reports
          - **Build Health**: Continuous integration validation

          EOF

      - name: Update README with Tool Information
        run: |
          # Create or update a section in README about developer tools
          if [ -f "README.md" ]; then
            if ! grep -q "## üõ†Ô∏è Developer Tools" README.md; then
              cat >> README.md << 'EOF'

          ## üõ†Ô∏è Developer Tools

          This project includes custom Unity editor tools to enhance developer productivity:

          - **üöÄ Performance Auditor Tool** - Automated performance analysis
          - **üõ†Ô∏è QA Automation Tool** - Comprehensive quality assurance testing
          - **‚ö° GameDev Workflow Tool** - Development workflow utilities

          Access these tools through the Unity Editor menu under `Laboratory/`.

          ### Quick Start
          1. Open project in Unity 6
          2. Tools auto-install on first load
          3. Access via Unity menu: `Laboratory/[Tool Name]`
          4. Follow in-tool guidance for usage

          For detailed usage instructions, see the developer guidelines in CI artifacts.
          EOF
              echo "‚úÖ Updated README.md with developer tools information"
            else
              echo "‚ÑπÔ∏è README.md already contains developer tools section"
            fi
          else
            echo "‚ö†Ô∏è README.md not found"
          fi

      - name: Upload Project Overview
        uses: actions/upload-artifact@v4
        with:
          name: project-overview
          path: project-overview.md
          retention-days: 365
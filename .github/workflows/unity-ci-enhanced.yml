# Enhanced Unity CI/CD Pipeline with Performance Monitoring and Developer Tools
name: Unity CI/CD - Enhanced

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'LICENSE'
      - '.gitignore'
      - 'COPILOT.md'
      - 'copilot-instructions.json'
  pull_request:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'LICENSE'
      - '.gitignore'

env:
  UNITY_VERSION: 6000.2.0f1
  PROJECT_NAME: ProjectChimera

jobs:
  # Pre-flight checks with our custom tools
  preflight-checks:
    name: Pre-flight Quality Checks
    runs-on: ubuntu-latest
    outputs:
      has-code-changes: ${{ steps.changes.outputs.code }}
      has-scene-changes: ${{ steps.changes.outputs.scenes }}
      performance-risk: ${{ steps.risk-assessment.outputs.risk-level }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect Changes
        id: changes
        run: |
          # Detect what types of files changed
          if git diff --name-only HEAD~1 | grep -E "\.cs$"; then
            echo "code=true" >> $GITHUB_OUTPUT
            echo "ðŸ” Code changes detected"
          else
            echo "code=false" >> $GITHUB_OUTPUT
          fi

          if git diff --name-only HEAD~1 | grep -E "\.(unity|prefab)$"; then
            echo "scenes=true" >> $GITHUB_OUTPUT
            echo "ðŸŽ¬ Scene/Prefab changes detected"
          else
            echo "scenes=false" >> $GITHUB_OUTPUT
          fi

      - name: Performance Risk Assessment
        id: risk-assessment
        run: |
          # Count code changes for risk assessment
          code_changes=$(git diff --name-only HEAD~1 | grep -E "\.cs$" | wc -l)

          if [ $code_changes -gt 20 ]; then
            echo "risk-level=high" >> $GITHUB_OUTPUT
            echo "ðŸ”´ High performance risk: $code_changes files changed"
          elif [ $code_changes -gt 10 ]; then
            echo "risk-level=medium" >> $GITHUB_OUTPUT
            echo "ðŸŸ¡ Medium performance risk: $code_changes files changed"
          else
            echo "risk-level=low" >> $GITHUB_OUTPUT
            echo "âœ… Low performance risk: $code_changes files changed"
          fi

      - name: Automated Performance Audit
        if: steps.changes.outputs.code == 'true'
        run: |
          echo "ðŸš€ Running automated performance audit..."

          # Performance pattern detection (similar to our Performance Auditor Tool)
          performance_issues=0

          # Check for expensive Update operations
          update_issues=$(grep -rn "Update.*\(FindObjectOfType\|GameObject\.Find\|GetComponent\)" Assets/ --include="*.cs" | wc -l)
          performance_issues=$((performance_issues + update_issues))

          # Check for LINQ in potential hot paths
          linq_issues=$(grep -rn "Update.*\(\.Where\|\.Select\|\.OrderBy\|\.ToList\)" Assets/ --include="*.cs" | wc -l)
          performance_issues=$((performance_issues + linq_issues))

          # Check for string concatenation
          string_issues=$(grep -rn '"\s*+\s*"' Assets/ --include="*.cs" | wc -l)
          if [ $string_issues -gt 5 ]; then
            performance_issues=$((performance_issues + 1))
          fi

          echo "ðŸ“Š Performance Issues Detected: $performance_issues"

          if [ $performance_issues -gt 0 ]; then
            echo "âš ï¸ Performance issues detected - detailed analysis required"
            echo "Use Performance Auditor Tool in Unity Editor for full analysis"
          fi

  # Code Quality & Security (enhanced)
  enhanced-code-quality:
    name: Enhanced Code Quality
    runs-on: ubuntu-latest
    needs: preflight-checks
    if: needs.preflight-checks.outputs.has-code-changes == 'true'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Advanced Code Analysis
        run: |
          echo "ðŸ” Running enhanced code analysis..."

          # Performance-focused analysis
          echo "Analyzing performance patterns..."

          # Check for cached component patterns (our optimization)
          cached_components=$(grep -rn "GetComponent.*cache\|componentCache" Assets/ --include="*.cs" | wc -l)
          echo "âœ… Found $cached_components cached component implementations"

          # Check for object pooling usage
          pooling_usage=$(grep -rn "pool\|Pool" Assets/ --include="*.cs" | wc -l)
          echo "â™»ï¸ Found $pooling_usage object pooling references"

          # Check for ECS usage
          ecs_usage=$(grep -rn "IComponentData\|SystemBase\|Entities\.ForEach" Assets/ --include="*.cs" | wc -l)
          echo "âš¡ Found $ecs_usage ECS implementations"

          # Quality metrics
          echo "ðŸ“Š Code Quality Metrics:"
          echo "- Cached Components: $cached_components"
          echo "- Object Pooling: $pooling_usage"
          echo "- ECS Usage: $ecs_usage"

      - name: Developer Tools Validation
        run: |
          echo "ðŸ› ï¸ Validating developer tools integration..."

          # Check if our Unity editor tools are present
          tools=(
            "Assets/Editor/PerformanceAuditorTool.cs"
            "Assets/Editor/QAAutomationTool.cs"
            "Assets/Editor/GameDevWorkflowTool.cs"
          )

          tools_present=0
          for tool in "${tools[@]}"; do
            if [ -f "$tool" ]; then
              echo "âœ… Tool present: $(basename $tool)"
              tools_present=$((tools_present + 1))
            else
              echo "âŒ Tool missing: $(basename $tool)"
            fi
          done

          echo "ðŸ› ï¸ Developer Tools: $tools_present/3 present"

      - name: Namespace Compliance Check
        run: |
          echo "ðŸ“¦ Checking namespace compliance..."

          # Check for proper Laboratory.* namespace usage
          non_compliant=$(grep -r "^namespace " Assets/_Project --include="*.cs" | grep -v "Laboratory\." | wc -l)

          if [ $non_compliant -eq 0 ]; then
            echo "âœ… All namespaces follow Laboratory.* convention"
          else
            echo "âš ï¸ Found $non_compliant files not using Laboratory.* namespace"
            grep -r "^namespace " Assets/_Project --include="*.cs" | grep -v "Laboratory\."
          fi

  # Unity Build & Test (enhanced with performance monitoring)
  enhanced-unity-build:
    name: Unity Build & Performance Test
    runs-on: ubuntu-latest
    needs: [preflight-checks, enhanced-code-quality]
    if: always() && (needs.enhanced-code-quality.result == 'success' || needs.preflight-checks.outputs.has-code-changes == 'false')

    strategy:
      matrix:
        include:
          - platform: StandaloneWindows64
            buildName: ProjectChimera-Windows
            buildsPath: Builds/Windows
          - platform: StandaloneLinux64
            buildName: ProjectChimera-Linux
            buildsPath: Builds/Linux

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      # Enhanced caching strategy
      - name: Cache Unity Library (Enhanced)
        uses: actions/cache@v4
        with:
          path: |
            Library
            obj
            Temp
            UserSettings
          key: Library-v2-${{ runner.os }}-${{ matrix.platform }}-${{ env.UNITY_VERSION }}-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-v2-${{ runner.os }}-${{ matrix.platform }}-${{ env.UNITY_VERSION }}-
            Library-v2-${{ runner.os }}-${{ matrix.platform }}-
            Library-v2-${{ runner.os }}-

      # Unity is automatically installed by unity-test-runner and unity-builder actions

      # Simulated Performance Tool Validation (since we can't run Unity Editor tools in CI)
      - name: Simulated Performance Validation
        run: |
          echo "ðŸš€ Simulating Performance Auditor Tool validation..."

          # Simulate the performance checks our tool would do
          critical_patterns=0

          # Check for critical performance anti-patterns
          findobj_in_update=$(grep -rn "Update.*FindObjectOfType" Assets/ --include="*.cs" | wc -l)
          getcomp_in_update=$(grep -rn "Update.*GetComponent.*(" Assets/ --include="*.cs" | wc -l)
          physics_in_update=$(grep -rn "Update.*Physics\." Assets/ --include="*.cs" | wc -l)

          critical_patterns=$((findobj_in_update + getcomp_in_update + physics_in_update))

          echo "ðŸ“Š Critical Performance Patterns Found: $critical_patterns"
          echo "- FindObjectOfType in Update: $findobj_in_update"
          echo "- GetComponent in Update: $getcomp_in_update"
          echo "- Physics calls in Update: $physics_in_update"

          if [ $critical_patterns -gt 5 ]; then
            echo "ðŸ”´ HIGH RISK: Many performance anti-patterns detected"
            echo "performance_risk=high" >> $GITHUB_ENV
          elif [ $critical_patterns -gt 2 ]; then
            echo "ðŸŸ¡ MEDIUM RISK: Some performance anti-patterns detected"
            echo "performance_risk=medium" >> $GITHUB_ENV
          else
            echo "âœ… LOW RISK: Few or no performance anti-patterns"
            echo "performance_risk=low" >> $GITHUB_ENV
          fi

      # Run tests with performance monitoring
      - name: Run Enhanced Tests
        uses: game-ci/unity-test-runner@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          unityVersion: ${{ env.UNITY_VERSION }}
          testMode: editmode
        continue-on-error: true

      # Build with performance profiling enabled
      - name: Build with Performance Profiling
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
          DEVELOPMENT_BUILD: ${{ needs.preflight-checks.outputs.performance-risk != 'low' }}
          ENABLE_PROFILER: ${{ needs.preflight-checks.outputs.performance-risk != 'low' }}
        with:
          unityVersion: ${{ env.UNITY_VERSION }}
          targetPlatform: ${{ matrix.platform }}
          buildName: ${{ matrix.buildName }}
          buildsPath: ${{ matrix.buildsPath }}
          buildMethod: BuildScript.BuildProject
          versioning: Semantic
          version: 1.0.${{ github.run_number }}

      - name: Performance Report Generation
        run: |
          cat > performance-build-report.md << EOF
          # ðŸš€ Performance Build Report

          **Build**: ${{ matrix.buildName }}
          **Platform**: ${{ matrix.platform }}
          **Commit**: ${{ github.sha }}
          **Performance Risk**: ${{ env.performance_risk }}

          ## Performance Metrics
          - Critical patterns detected: See build logs
          - Build configuration: ${{ env.performance_risk != 'low' && 'Development + Profiler' || 'Release' }}
          - Performance tools: Integrated and validated

          ## Recommendations
          ${{ env.performance_risk == 'high' && 'ðŸ”´ HIGH PRIORITY: Run Performance Auditor Tool in Unity Editor' || '' }}
          ${{ env.performance_risk == 'medium' && 'ðŸŸ¡ RECOMMENDED: Review performance with QA Automation Tool' || '' }}
          ${{ env.performance_risk == 'low' && 'âœ… Performance looks good - continue monitoring' || '' }}

          ## Available Tools for Optimization
          - ðŸš€ Performance Auditor Tool (Unity Editor)
          - ðŸ› ï¸ QA Automation Tool (Unity Editor)
          - âš¡ GameDev Workflow Tool (Unity Editor)

          Access: Unity Editor â†’ Menu â†’ Laboratory â†’ [Tool Name]
          EOF

      - name: Upload Enhanced Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.buildName }}-enhanced-${{ github.sha }}
          path: |
            ${{ matrix.buildsPath }}
            performance-build-report.md
          retention-days: 90

  # Performance Quality Gate
  performance-quality-gate:
    name: Performance Quality Gate
    runs-on: ubuntu-latest
    needs: [preflight-checks, enhanced-unity-build]
    if: always()

    steps:
      - name: Evaluate Performance Quality
        run: |
          performance_risk="${{ needs.preflight-checks.outputs.performance-risk }}"

          echo "ðŸš€ Performance Quality Gate Evaluation"
          echo "Performance Risk Level: $performance_risk"

          case $performance_risk in
            "high")
              echo "ðŸ”´ QUALITY GATE FAILED: High performance risk detected"
              echo "Required Actions:"
              echo "1. Run Performance Auditor Tool in Unity Editor"
              echo "2. Address critical performance issues"
              echo "3. Re-run CI pipeline after fixes"
              exit 1
              ;;
            "medium")
              echo "ðŸŸ¡ QUALITY GATE WARNING: Medium performance risk"
              echo "Recommended Actions:"
              echo "1. Review with Performance Auditor Tool"
              echo "2. Consider optimization before production"
              echo "Build allowed but monitoring required"
              ;;
            "low"|*)
              echo "âœ… QUALITY GATE PASSED: Low performance risk"
              echo "Performance monitoring: Continues as normal"
              ;;
          esac

      - name: Generate Quality Gate Report
        run: |
          cat > quality-gate-report.md << EOF
          # ðŸš€ Performance Quality Gate Report

          **Status**: ${{ needs.preflight-checks.outputs.performance-risk }}
          **Timestamp**: $(date)
          **Commit**: ${{ github.sha }}

          ## Quality Gate Results
          Performance risk assessment: ${{ needs.preflight-checks.outputs.performance-risk }}

          ## Developer Action Items
          - Use Performance Auditor Tool for detailed analysis
          - Run QA Automation Tool for comprehensive validation
          - Monitor build performance metrics

          ## Tool Access
          Unity Editor â†’ Menu â†’ Laboratory â†’ [Tool Name]

          EOF

      - name: Upload Quality Gate Report
        uses: actions/upload-artifact@v4
        with:
          name: quality-gate-report-${{ github.sha }}
          path: quality-gate-report.md
          retention-days: 30